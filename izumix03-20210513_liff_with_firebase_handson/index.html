
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>LIFFã‚¢ãƒ—ãƒªã‚’Firebaseã§å‹•ã‹ã™ãƒãƒ³ã‚ºã‚ªãƒ³</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="G-DC76XXBQMH"
                  id="izumix03-20210513_liff_with_firebase_handson"
                  title="LIFFã‚¢ãƒ—ãƒªã‚’Firebaseã§å‹•ã‹ã™ãƒãƒ³ã‚ºã‚ªãƒ³"
                  environment="web"
                  feedback-link="https://github.com/izumix03/liff_firebase_handson">
    
      <google-codelab-step label="LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ" duration="3">
        <h2 is-upgraded>LINE Developersã¸ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</h2>
<p><a href="https://account.line.biz/login?redirectUri=https%3A%2F%2Fdevelopers.line.biz%2Fconsole%2F" target="_blank">LINE Developers</a>ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§[ã‚³ãƒ³ã‚½ãƒ¼ãƒ«]ã‚‚ã—ãã¯[ãƒ­ã‚°ã‚¤ãƒ³]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚</p>
<p class="image-container"><img src="img/e7e771d2ee8db9ad.png"></p>
<p>LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="æ–°è¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä½œæˆ" duration="3">
        <p>é–‹ç™ºè€…ã®æ‰€å±ã¨ãªã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®[ä½œæˆ]ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
<p>å€‹äººé–‹ç™ºè€…ã§ã™ã®ã§ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åã¯æœ¬åã§ã‚‚ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã‚‚ä»»æ„ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
<p class="image-container"><img src="img/542bda589cc8fac3.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="ãƒãƒ£ãƒãƒ«ï¼ˆLINEãƒ­ã‚°ã‚¤ãƒ³ï¼‰ä½œæˆ" duration="3">
        <p>LIFFã‚¢ãƒ—ãƒªã®ãŸã‚ã«LINEãƒ­ã‚°ã‚¤ãƒ³ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<p class="image-container"><img src="img/e113fd310fb5ba95.png"></p>
<table>
<tr><td colspan="1" rowspan="1"><p>ãƒãƒ£ãƒãƒ«ã®ç¨®é¡</p>
</td><td colspan="1" rowspan="1"><p>LINEãƒ­ã‚°ã‚¤ãƒ³</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</p>
</td><td colspan="1" rowspan="1"><p>handson(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>åœ°åŸŸ</p>
</td><td colspan="1" rowspan="1"><p>æ—¥æœ¬</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒãƒ£ãƒãƒ«ã‚¢ã‚¤ã‚³ãƒ³</p>
</td><td colspan="1" rowspan="1"><p>(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒãƒ£ãƒãƒ«å</p>
</td><td colspan="1" rowspan="1"><p>handsonãƒ­ã‚°ã‚¤ãƒ³(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒãƒ£ãƒãƒ«èª¬æ˜</p>
</td><td colspan="1" rowspan="1"><p>handsonãƒ­ã‚°ã‚¤ãƒ³(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒ—</p>
</td><td colspan="1" rowspan="1"><p>ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</p>
</td><td colspan="1" rowspan="1"><p>(è‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼URL</p>
</td><td colspan="1" rowspan="1"><p>(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨è¦ç´„URL</p>
</td><td colspan="1" rowspan="1"><p>(ä»»æ„)</p>
</td></tr>
</table>


      </google-codelab-step>
    
      <google-codelab-step label="LIFFã®è¨­å®š" duration="3">
        <p>LIFFã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ <img src="img/bdb88d9834d8ad76.png"></p>
<table>
<tr><td colspan="1" rowspan="1"><p>LIFFã‚¢ãƒ—ãƒªå</p>
</td><td colspan="1" rowspan="1"><p>handson-liff(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚µã‚¤ã‚º</p>
</td><td colspan="1" rowspan="1"><p>Full(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL</p>
</td><td colspan="1" rowspan="1"><p>https://example.com (ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Scope</p>
</td><td colspan="1" rowspan="1"><p>profile</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ãƒœãƒƒãƒˆãƒªãƒ³ã‚¯æ©Ÿèƒ½</p>
</td><td colspan="1" rowspan="1"><p>On (Aggressive)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</p>
</td><td colspan="1" rowspan="1"><p>(ãªã—)</p>
</td></tr>
</table>
<p>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã¯å¾Œã»ã©æ›¸ãæ›ãˆã¾ã™ã€‚</p>
<p>Scope ã§ã¯IDãƒˆãƒ¼ã‚¯ãƒ³ä½¿ã„ãŸã„å ´åˆ <code>openid</code> ã‚‚é¸æŠã—ã¾ã—ã‚‡ã†ã€‚ â€»ä»Šå›ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã§ã¯ <code>profile</code> ã—ã‹ä½¿ã„ã¾ã›ã‚“ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="Firebase è¨­å®š" duration="10">
        <h2 is-upgraded>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
<p>Bitkey ã® Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ Firebase ã®ã‚µã‚¤ãƒˆã‚’é–‹ãã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚ https://console.firebase.google.com/</p>
<table>
<tr><td colspan="1" rowspan="1"><p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</p>
</td><td colspan="1" rowspan="1"><p>handson-liff(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹</p>
</td><td colspan="1" rowspan="1"><p>ç„¡åŠ¹</p>
</td></tr>
</table>
<h2 is-upgraded>Webã‚¢ãƒ—ãƒªã‚’è¿½åŠ </h2>
<table>
<tr><td colspan="1" rowspan="1"><p>ã‚¢ãƒ—ãƒªã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </p>
</td><td colspan="1" rowspan="1"><p>handson-liff(ä»»æ„)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>hosting</p>
</td><td colspan="1" rowspan="1"><p>åˆ©ç”¨ã™ã‚‹</p>
</td></tr>
</table>
<h2 is-upgraded>ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ¼ãƒ‰ã‚’æº–å‚™</h2>
<p>å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹ãªã©å¿˜ã‚Œãšã«ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code language="language-shell" class="language-shell">yarn global add firebase-tools
exec $SHELL -l
firebase login --reauth
</code></pre>
<pre><code language="language-shell" class="language-shell">firebase init --project {projectå}
</code></pre>
<p>ã¾ãšä½¿ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’èã‹ã‚Œã‚‹ã®ã§ã€ Functions, Hosting, Emulators ã‚’é¸æŠã—ã¾ã™ã€‚</p>
<pre><code language="language-shell" class="language-shell">? What language would you like to use to write Cloud Functions? TypeScript
? Do you want to use ESLint to catch probable bugs and enforce style? Yes
âœ”  Wrote functions/package.json
âœ”  Wrote functions/.eslintrc.js
âœ”  Wrote functions/tsconfig.json
âœ”  Wrote functions/src/index.ts
âœ”  Wrote functions/.gitignore
? Do you want to install dependencies with npm now? No

=== Hosting Setup

Your public directory is the folder (relative to your project directory) that
will contain Hosting assets to be uploaded with firebase deploy. If you
have a build process for your assets, use your build&#39;s output directory.

? What do you want to use as your public directory? hosting/build
? Configure as a single-page app (rewrite all urls to /index.html)? No
? Set up automatic builds and deploys with GitHub? No

=== Emulators Setup
? Which Firebase emulators do you want to set up? Press Space to select emulators, then Enter to con
firm your choices. Authentication Emulator, Functions Emulator, Hosting Emulator
? Which port do you want to use for the auth emulator? 9099
? Which port do you want to use for the functions emulator? 5001
? Which port do you want to use for the hosting emulator? 5000
? Would you like to enable the Emulator UI? Yes
? Which port do you want to use for the Emulator UI (leave empty to use any available port)? 
? Would you like to download the emulators now? No

i  Writing configuration info to firebase.json...
i  Writing project information to .firebaserc...
i  Writing gitignore file to .gitignore...

âœ”  Firebase initialization complete!
</code></pre>
<h2 is-upgraded>hostingã®ã‚³ãƒ¼ãƒ‰ã‚’Reactã§ç”¨æ„</h2>
<pre><code language="language-shell" class="language-shell">npx create-react-app hosting --template redux-typescript
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="å‹•ä½œç¢ºèªã¨ãƒ‡ãƒ—ãƒ­ã‚¤" duration="5">
        <h2 is-upgraded>ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•</h2>
<p>ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code language="language-shell:hosting" class="language-shell:hosting">yarn start
</code></pre>
<p>å‹•ãã¾ã—ãŸã­ã€‚ ã§ã¯ãƒ“ãƒ«ãƒ‰ã—ã¦hostingã®emulatorã‚‚ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code language="language-shell:hosting" class="language-shell:hosting">yarn build
firebase emulators:start
</code></pre>
<p>å‹•ä½œç¢ºèªã§ãã¾ã—ãŸã­ã€‚</p>
<p>ã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code language="language-shell" class="language-shell">firebase deploy --only hosting
</code></pre>
<p>å‹•ä½œç¢ºèªã§ãã¾ã—ãŸã­ã€‚</p>


      </google-codelab-step>
    
      <google-codelab-step label="LIFFã‚¢ãƒ—ãƒªã‚’å®Ÿè£…æº–å‚™" duration="10">
        <pre><code language="language-shell:hosting" class="language-shell:hosting">rm -rf src/features/counter
</code></pre>
<h3 is-upgraded>â–¡ä¸è¦ãªã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†</h3>
<p>ã¾ãšä¸è¦ãªã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
<pre><code language="language-shell:hosting" class="language-shell:hosting">rm -rf src/features/counter
rm -f src/App.test.tsx
rm -f src/App.css
</code></pre>
<p>â€»ãƒ†ã‚¹ãƒˆãªã‚“ã‹ã„ã‚‰ãªã„ã¨ã„ã†æ„å‘³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚  App.txsã‚’æ›¸ãæ›ãˆã‚‹ã®ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆã¯ã“ã“ã§èª¬æ˜ã—ãªã„ã®ã§å‰Šé™¤ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code language="language-diff:hosting/src/app/store.ts" class="language-diff:hosting/src/app/store.ts">-import counterReducer from &#39;../features/counter/counterSlice&#39;;

//...
-    counter: counterReducer,
</code></pre>
<pre><code language="language-typescript:hosting/src/App.tsx" class="language-typescript:hosting/src/App.tsx">import React from &#39;react&#39;;
import &#39;./App.css&#39;;

export const App = () =&gt; {
  return (
    &lt;div className=&#34;App&#34;&gt;&lt;/div&gt;
  );
}
</code></pre>
<pre><code language="language-shell:hosting" class="language-shell:hosting">yarn add firebase axios @line/liff
# ä»Šå›èª¬æ˜ã—ã¾ã›ã‚“ãŒã€ãƒ‡ã‚¶ã‚¤ãƒ³ã—ãŸã„æ–¹ã¯ä»¥ä¸‹ã‚‚ã„ã‚Œã¾ã—ã‚‡ã†
# yarn add @material-ui/core @material-ui/icons
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="LIFFã‚¢ãƒ—ãƒªã‚’å®Ÿè£…" duration="5">
        <h2 is-upgraded>Firebaseã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†</h2>
<p>æ™®é€š<code>.env</code> ã«è¨˜è¼‰ã—ã¦ä½¿ã†ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ç›´æ¥è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code language="language-shell:hosting" class="language-shell:hosting">mkdir src/configs
touch src/configs/firebaseApp.ts
</code></pre>
<pre><code language="language-typescript:hosting/src/configs/firebaseApp.ts" class="language-typescript:hosting/src/configs/firebaseApp.ts">import firebase from &#39;firebase/app&#39;;
import &#39;firebase/auth&#39;;

const firebaseConfig = {
  apiKey: &#34;XXXX&#34;,
  authDomain: &#34;XXXX&#34;,
  projectId: &#34;XXXX&#34;,
  storageBucket: &#34;XXXX&#34;,
  messagingSenderId: &#34;XXXX&#34;,
  appId: &#34;XXXX&#34;
};

const firebaseApp = firebase.initializeApp(firebaseConfig);
export const auth = firebaseApp.auth();
</code></pre>
<p><code>firebaseConfig</code> ã®å†…å®¹ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ <code>ãƒ—</code>ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š ã‚’é€²ã¿ã¾ã—ã‚‡ã†ã€‚ <code>å…</code>¨èˆ¬ ã‚¿ã‚°ã« <code>Firebase SDK snippet</code> ãŒã‚ã‚‹ã®ã§ã€ ãã“ã§ <code>æ§</code>‹æˆ ã‚’é¸æŠã™ã‚‹ã¨ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚</p>
<p>ã¾ãŸã€ä»Šå›ã¯ã‚„ã‚Šã¾ã›ã‚“ãŒã€Firestoreã‚’ä½¿ã£ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚‚æ›¸ãå ´åˆãªã©ã¯ã€ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã™ã‚‹ã®ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚</p>
<h2 is-upgraded>ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã¦è¡¨ç¤ºã‚’å¤‰æ›´ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯</h2>
<pre><code language="language-typescript:hosting/src/App.tsx" class="language-typescript:hosting/src/App.tsx">import React from &#39;react&#39;;

export const App = () =&gt; {
  const [user] = useUser();

  return (
    &lt;&gt;
      { user? (&lt;p&gt;èªè¨¼å®Œäº†&lt;/p&gt;) : (&lt;p&gt;æœªèªè¨¼&lt;/p&gt;) }
    &lt;/&gt;
  )
}
</code></pre>
<p>æœ¬å½“ã¯App.tsxã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ã ã‘ç®¡ç†ã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ ä»Šå›ã¯ã“ã“ã«ç›´æ¥æ›¸ã„ã¦ã—ã¾ã„ã¾ã™ã€‚</p>
<p>ã¾ã  <code>useUser</code> ã‚’ä½œã£ã¦ã„ãªã„ã®ã§ç¾çŠ¶ã¯ã‚¨ãƒ©ãƒ¼ã—ã¾ã™ã€‚</p>
<p>ã§ã¯ç‹¬è‡ªãƒ•ãƒƒã‚¯ã§ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚</p>
<pre><code language="language-shell:hosting" class="language-shell:hosting">mkdir src/hooks
touch src/hooks/useUser.ts
</code></pre>
<pre><code language="language-typescript:hosting/src/hooks/useUser.ts" class="language-typescript:hosting/src/hooks/useUser.ts">import {useContext, useEffect, useRef, useState} from &#39;react&#39;;
import firebase from &#39;firebase/app&#39;;
import liff from &#39;@line/liff&#39;;
import axios from &#39;axios&#39;;
import { auth } from &#39;../configs/firebaseApp&#39;;

const liffId = &#39;XXXXX&#39;;

export const useUser = () =&gt; {
  const [user, setUser] = useState&lt;firebase.User | null&gt;(null);

  useEffect(() =&gt; {
    let unmount = false;

    const unSub = auth.onAuthStateChanged(async authUser =&gt; {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) {
        await liff.login()
        return
      }

      if (authUser &amp;&amp; !unmount) {
        setUser(authUser)
        return
      }

      const accessToken = liff.getAccessToken();
      if (!accessToken) return;

      const result = await axios.post(&#39;/login&#39;, { accessToken });
      if (result.data.error) {
        console.error(&#39;functions error&#39;, result.data.error);
        return
      }

      const res = await auth!.signInWithCustomToken(result.data.token);
      if (!unmount) setUser(res.user);
    })

    return () =&gt; {
      unmount = true;
      unSub();
    }
  }, []);

  return [user] as const;
}
</code></pre>
<p><code>liffId</code> ã¨ã„ã†ã®ãŒå‡ºã¦ãã¾ã—ãŸã€‚ LINEãƒ­ã‚°ã‚¤ãƒ³ã‚’ä½¿ã†ãŸã‚ã«å¿…è¦ãªã®ã§å…ˆç¨‹ä½œã£ãŸLIFFã‚¢ãƒ—ãƒªã®ç”»é¢ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ãã¾ã—ã‚‡ã†ã€‚</p>
<h2 is-upgraded>firebase.json ã‚’ç·¨é›†</h2>
<p>axiosã§ <code>/login</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã­ã€‚ hostingã®ãƒ‘ã‚¹ã‚’functionsã«å‘ã‘ã¦å‡¦ç†ã•ã›ã‚‹ãŸã‚ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚ firebase.jsonã‚’ç·¨é›†ã—ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code language="language-diff:firebase.json" class="language-diff:firebase.json">  &#34;hosting&#34;: {
    &#34;public&#34;: &#34;hosting/build&#34;,
    &#34;ignore&#34;: [
      &#34;firebase.json&#34;,
      &#34;**/.*&#34;,
      &#34;**/node_modules/**&#34;
    ],
    &#34;rewrites&#34;: [
      {
        &#34;source&#34;: &#34;**&#34;,
        &#34;destination&#34;: &#34;/index.html&#34;
-      },
+      },
+      {
+        &#34;source&#34;: &#34;/login&#34;,
+        &#34;function&#34;: &#34;loginUsCentral&#34;
+      }
    ]
  },
</code></pre>
<p>ã“ã‚Œã§hostingã‚’ä½¿ã£ãŸãƒ•ãƒ­ãƒ³ãƒˆã®å‡¦ç†ã¯çµ‚ã‚ã‚Šã§ã™ã€‚</p>
<h2 is-upgraded>ãƒ‡ãƒ—ãƒ­ã‚¤</h2>
<pre><code language="language-shell" class="language-shell">firebase deploy --only hosting
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Firebase Functionsã‚’å®Ÿè£…" duration="5">
        <p>LINEã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã‚Šã€ LINEã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã—ã€ Firebase Authenticationã®ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹ã¨ã„ã†å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚</p>
<p>ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã«ä½•ã‚‚å·¥å¤«ã›ãšæ›¸ãã¾ã™ã€‚</p>
<h2 is-upgraded>å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h2>
<pre><code language="language-shell:functions" class="language-shell:functions">yarn add axios firebase-admin firebase-functions
</code></pre>
<pre><code language="language-typescript:functions/src/index.ts" class="language-typescript:functions/src/index.ts">import * as admin from &#39;firebase-admin&#39;;
import * as functions from &#39;firebase-functions&#39;;
import axios from &#39;axios&#39;;

// ã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ JSON ãƒ•ã‚¡ã‚¤ãƒ«
import serviceAccount from &#39;./config/serviceAccountKey.json&#39;;

const channelId = &#39;XXXX&#39;;

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount as admin.ServiceAccount),
});

const axiosInstance = axios.create({
  baseURL: &#39;https://api.line.me&#39;,
  responseType: &#39;json&#39;,
});

const verifyToken = async (accessToken: string) =&gt; {
  const response = await axiosInstance.get(&#39;/oauth2/v2.1/verify&#39;, {
    params: { access_token: accessToken },
  });

  if (response.status !== 200) {
    console.error(response.data.error_description);
    throw new Error(response.data.error);
  }

  if (response.data.client_id !== channelId) {
    throw new Error(&#39;client_id does not match.&#39;);
  }

  if (response.data.expires_in &lt; 0) {
    throw new Error(&#39;access token is expired.&#39;);
  }
};

const getProfile = async (accessToken: string) =&gt; {
  const response = await axiosInstance.get(&#39;/v2/profile&#39;, {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
    data: {},
  });

  if (response.status !== 200) {
    console.error(response.data.error_description);
    throw new Error(response.data.error);
  }

  return response.data;
};

exports.loginUsCentral = functions
  .region(&#39;us-central1&#39;)
  .https.onRequest(async (req, res) =&gt; {
    const { accessToken } = req.body;

    if (!accessToken) {
        res.status(500).send({ error: &#39;invalid access&#39; });
        return;
    }

    try {
      await verifyToken(accessToken);
      const profile = await getProfile(accessToken);
      const token = await admin.auth().createCustomToken(profile.userId);

      res.send({ token });
    } catch (e) {
      console.error(JSON.stringify(e, null, &#39;  &#39;));

      res.status(500).send({ error: e.message });
    }
  });
</code></pre>
<p>channelIdã¯LINEãƒ­ã‚°ã‚¤ãƒ³ã®ãƒãƒ£ãƒãƒ«IDã‚’å…¥ã‚Œã¦ä¸‹ã•ã„ã€‚ <code>serviceAccountKey.json</code> ã¯Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®jsonã‚’ä½œæˆã—ã¦ä¿å­˜ã—ã€ãƒªãƒãƒ¼ãƒ ã—ã¦ä½¿ã£ã¦ä¸‹ã•ã„ã€‚</p>
<p>â€»rewrite ã™ã‚‹ãŸã‚ã«ã¯ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒ us-central1 ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ <code>.region(&#39;us-central1&#39;)</code>ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
<h2 is-upgraded>ãƒ‡ãƒ—ãƒ­ã‚¤</h2>
<pre><code language="language-shell" class="language-shell">firebase deploy --only functions
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®š" duration="0">
        <p>LIFFã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã‚’hostingã®URLã«æ›¸ãæ›ãˆã¾ã—ã‚‡ã†ï¼</p>
<p>ã“ã‚Œã§çµ‚äº†ã§ã™ï¼</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
